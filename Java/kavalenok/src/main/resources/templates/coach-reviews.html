<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Отзывы о тренере</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link th:href="@{/css/style.css}" rel="stylesheet">
</head>
<body>

<div th:replace="layout/header :: header"></div>

<section class="coaches-section">
    <div class="container">
        <div class="coaches-header">
            <h1 class="coaches-title">Отзывы о тренере</h1>
            <a th:href="@{/coaches}" class="btn btn-outline-primary mt-3">
                <i class="fas fa-arrow-left me-2"></i>Назад к списку тренеров
            </a>
        </div>

        <div th:if="${successMessage}" class="alert alert-success" th:text="${successMessage}"></div>
        <div th:if="${errorMessage}" class="alert alert-danger" th:text="${errorMessage}"></div>

        <div th:if="${#lists.isEmpty(reviews)}" class="no-results">
            <i class="fas fa-star no-results-icon"></i>
            <h3>У этого тренера пока нет отзывов</h3>
            <p th:if="${canLeaveReview}">Будьте первым, кто оставит отзыв!</p>
        </div>

        <div th:if="${not #lists.isEmpty(reviews)}" class="row">
            <div th:each="review : ${reviews}" class="col-12 mb-4">
                <div class="coach-card-enhanced p-3">
                    <div class="d-flex">
                        <img th:src="@{${review.user.avatarUrl} ?: '/img/avatars/1.png'}"
                             class="rounded-circle me-3" width="60" height="60">
                        <div class="flex-grow-1">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 th:text="${review.user.firstName} + ' ' + ${review.user.lastName}"></h5>
                                <span class="text-muted small"
                                      th:text="${#temporals.format(review.createdAt, 'dd.MM.yyyy HH:mm')}">
                                </span>
                            </div>
                            <div class="mb-2">
                                <span th:each="i : ${#numbers.sequence(1, 5)}">
                                    <i th:if="${i <= review.rating}" class="fas fa-star text-warning"></i>
                                    <i th:if="${i > review.rating}" class="far fa-star text-warning"></i>
                                </span>
                                <span class="ms-2 fw-bold" th:text="${review.rating} + '/5'"></span>
                            </div>
                            <p th:if="${review.comment != null}" th:text="${review.comment}" class="mb-0"></p>
                            <p th:if="${review.comment == null}" class="text-muted fst-italic mb-0">Без комментария</p>

                            <div th:if="${session.user != null and (session.user.id == review.user.id or session.user.role.name() == 'ADMIN')}"
                                 class="mt-2">
                                <form th:action="@{/coach/review/{id}/delete(id=${review.id})}" method="post">
                                    <button type="submit" class="btn btn-sm btn-outline-danger">
                                        <i class="fas fa-trash me-1"></i>Удалить
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div th:if="${session.user != null}" class="mt-5">
            <div class="coach-card-enhanced p-4">
                <h4 class="mb-3">Оставить отзыв</h4>
                <form th:action="@{/coach/{coachId}/review(coachId=${coachId})}" method="post">
                    <input type="hidden" name="rating" id="ratingValue" value="5">

                    <div class="mb-3">
                        <label class="form-label">Оценка</label>
                        <div class="star-rating">
                            <i class="far fa-star" data-value="5"></i>
                            <i class="far fa-star" data-value="4"></i>
                            <i class="far fa-star" data-value="3"></i>
                            <i class="far fa-star" data-value="2"></i>
                            <i class="far fa-star" data-value="1"></i>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="comment" class="form-label">Комментарий (необязательно)</label>
                        <textarea class="form-control" id="comment" name="comment" rows="3"
                                  placeholder="Поделитесь впечатлениями..."></textarea>
                    </div>

                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-paper-plane me-2"></i>Отправить отзыв
                    </button>
                </form>
            </div>
        </div>

        <div th:if="${session.user == null}" class="mt-5">
            <div class="coach-card-enhanced p-4 text-center">
                <a th:href="@{/login}" class="btn btn-primary btn-lg">
                    <i class="fas fa-sign-in-alt me-2"></i>Войдите, чтобы оставить отзыв
                </a>
            </div>
        </div>
    </div>
</section>

<div th:replace="layout/footer :: footer"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const stars = document.querySelectorAll('.star-rating i');
        const ratingInput = document.getElementById('ratingValue');

        ratingInput.value = 5;
        highlightStars(5);

        stars.forEach(star => {
            star.addEventListener('click', function () {
                const value = parseInt(this.dataset.value);
                ratingInput.value = value;
                highlightStars(value);
            });

            star.addEventListener('mouseenter', function () {
                const value = parseInt(this.dataset.value);
                highlightStars(value);
            });

            star.addEventListener('mouseleave', function () {
                const currentValue = parseInt(ratingInput.value);
                highlightStars(currentValue);
            });
        });

        function highlightStars(value) {
            stars.forEach(star => {
                const starValue = parseInt(star.dataset.value);
                if (starValue <= value) {
                    star.classList.remove('far');
                    star.classList.add('fas');
                } else {
                    star.classList.remove('fas');
                    star.classList.add('far');
                }
            });
        }
    });
</script>
</body>
</html>